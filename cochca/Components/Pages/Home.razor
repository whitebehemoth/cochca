@page "/"
@page "/{SessionId}"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IConfiguration Config
@inject cochca.Services.LocalizationService L
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Home</PageTitle>

<!-- Row 1: Header + Language -->
<div class="app-row app-row--header">
    <div class="app-row__title">@L["AppTitle"]</div>
    <button class="btn btn-outline-secondary" @onclick="ToggleLanguage">@L.ToggleLabel</button>
</div>

<!-- Row 2: Session ID / Password -->
<div class="app-row">
    <div class="session-control">
        <label class="session-control__label">@L["PasswordLabel"]</label>
        <div class="session-control__input-group">
            <span class="session-control__prefix">@BaseUrl/</span>
            <input class="form-control session-control__input" @bind="SessionId" readonly="@IsConnected" placeholder="xxxx" />
            <button class="icon-btn icon-btn--primary" @onclick="CopyLinkAsync" disabled="@IsConnected" title="@L["CopyLink"]">
                <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
            </button>
        </div>
        @if (ShowLinkCopied)
        {
            <div class="session-control__hint session-control__hint--success">@L["LinkCopied"]</div>
        }
        @if (!string.IsNullOrWhiteSpace(StatusKey))
        {
            <div class="status @(StatusIsError ? "status-error" : "status-ok")">@L[StatusKey]</div>
        }
    </div>
</div>

<!-- Row 3: Connection controls + Tab switcher -->
<div class="app-row">
    <div class="control-bar">
        <button class="icon-btn icon-btn--connect" @onclick="ConnectAsync" disabled="@IsConnected" title="@L["Connect"]">
            <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                <path d="M7 2v2h6V2h2v2h1c1.1 0 2 .9 2 2v2h-2V6H6v12h6v2H6c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h1V2h2zm6 6 5 4-5 4v-3H9v-2h4V8z" />
            </svg>
        </button>
        <button class="icon-btn icon-btn--disconnect" @onclick="DisconnectAsync" disabled="@(!IsConnected)" title="@L["Disconnect"]">
            <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                <path d="M7 2v2h6V2h2v2h1c1.1 0 2 .9 2 2v2h-2V6H6v12h6v2H6c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h1V2h2zm2 6v2h4v2H9v2l-5-4 5-4z" />
            </svg>
        </button>
        <button class="icon-btn @(SelectedTab == Tab.Call ? "icon-btn--active" : "icon-btn--neutral")" @onclick="() => SelectTab(Tab.Call)" disabled="@(!IsConnected)" title="@L["Call"]">
            <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                <path d="M17 10.5V6.8c0-1-.8-1.8-1.8-1.8H4.8C3.8 5 3 5.8 3 6.8v10.4C3 18.2 3.8 19 4.8 19h10.4c1 0 1.8-.8 1.8-1.8v-3.7l3.5 3.5V7l-3.5 3.5z" />
            </svg>
        </button>
        <button class="icon-btn @(SelectedTab == Tab.Chat ? "icon-btn--active" : "icon-btn--neutral")" @onclick="() => SelectTab(Tab.Chat)" disabled="@(!IsConnected)" title="@L["Chat"]">
            <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
        </button>
    </div>
</div>

<!-- Row 4: Content (Chat or Call) -->
<div class="app-row app-row--content">
    @if (SelectedTab == Tab.Chat)
    {
        <div class="chat-container">
            <div class="chat-messages">
                @if (Messages.Count == 0)
                {
                    <div class="status status-ok">@L["ChatHint"]</div>
                }
                @foreach (var message in Messages)
                {
                    <div class="chat-message @(message.IsLocal ? "local" : string.Empty)">
                        <div class="chat-meta">@message.SenderName</div>
                        @if (!string.IsNullOrWhiteSpace(message.Text))
                        {
                            <div>@message.Text</div>
                        }
                        @if (message.HasFile)
                        {
                            if (message.IsImage)
                            {
                                <img class="chat-image" src="data:@message.ContentType;base64,@message.Base64" alt="@message.FileName" />
                            }
                            else
                            {
                                <a href="data:@message.ContentType;base64,@message.Base64" download="@message.FileName">@message.FileName</a>
                            }
                        }
                    </div>
                }
            </div>

            <div class="stack">
                <label>@L["Name"]</label>
                <input class="form-control" @bind="DisplayName" disabled="@(!IsConnected)" />
            </div>

            <div class="stack">
                <label>@L["Message"]</label>
                <textarea class="form-control" rows="3" @bind="MessageText" disabled="@(!IsConnected)"></textarea>
                <div class="stack stack-row">
                    <button class="btn btn-primary" @onclick="SendMessageAsync" disabled="@(!IsConnected)">@L["Send"]</button>
                    <InputFile OnChange="OnFileSelected" disabled="@(!IsConnected)" />
                </div>
            </div>
        </div>
    }
    else
    {
        <div id="videoStage" class="video-stage">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            <button class="video-camera-toggle @(IsVideoEnabled ? "video-camera-toggle--on" : "video-camera-toggle--off")" @onclick="ToggleVideoAsync" title="@L["ToggleCamera"]">
                <svg viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                    @if (IsVideoEnabled)
                    {
                        <path d="M17 10.5V6.8c0-1-.8-1.8-1.8-1.8H4.8C3.8 5 3 5.8 3 6.8v10.4C3 18.2 3.8 19 4.8 19h10.4c1 0 1.8-.8 1.8-1.8v-3.7l3.5 3.5V7l-3.5 3.5z" />
                    }
                    else
                    {
                        <path d="M21 6.5l-3.5 3.5V7c0-1-.8-1.8-1.8-1.8H9.8L21 16.4V6.5zM3.9 2.5L2.5 3.9 4.2 5.6c-.1.2-.2.4-.2.6v10.4C4 18.2 4.8 19 5.8 19h10.4c.4 0 .8-.1 1.1-.4l2.4 2.4 1.4-1.4L3.9 2.5zM15 17.4H6V8.6l8.1 8.1c-.3.4-.7.7-1.1.7z"/>
                    }
                </svg>
            </button>
        </div>
    }
</div>
